#!/usr/bin/env bash
set -euo pipefail

GROQSH="./bin/groqshell"

echo "Eseguo smoke test su: $GROQSH"

# 1) --version
if $GROQSH --version >/dev/null 2>&1; then
  echo "1) Verifica --version"
  echo "  OK: --version eseguito"
else
  echo "1) Verifica --version"
  echo "  FAIL: --version fallito"
  exit 1
fi

# 2) --dry-run
echo
echo "2) Verifica --dry-run (payload JSON)"
out="$($GROQSH --dry-run "test payload" 2>&1)" || { echo "  FAIL: --dry-run ha fallito"; echo "$out"; exit 1; }

# Verifica che l'output sia JSON valido (usa jq se presente, altrimenti python)
if command -v jq >/dev/null 2>&1; then
  echo "$out" | jq . >/dev/null 2>&1 || { echo "  FAIL: output non è JSON valido"; echo "$out"; exit 1; }
else
  python3 - <<PY >/dev/null 2>&1 || { echo "  FAIL: output non è JSON valido (python fallback)"; echo "$out"; exit 1; }
import sys, json
json.load(sys.stdin)
PY
fi

echo "  OK: --dry-run ha stampato payload JSON valido"
